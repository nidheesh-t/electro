<%- include("../../views/partials/admin/header") %>

    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, private">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <style>
        .responsive-table img {
            max-width: 50px;
            max-height: 50px;
            object-fit: cover;
        }

        @media screen and (max-width: 600px) {
            .responsive-table {
                font-size: 14px;
            }

            .responsive-table th,
            .responsive-table td {
                padding: 8px 4px;
            }
        }
    </style>

    <main>
        <div class="container">
            <div class="section">
                <h4 class="blue-text text-darken-2">Product Management</h4>
            </div>

            <div class="row">
                <div class="col s12">
                    <div class="card">
                        <div class="card-content">
                            <span class="card-title">Product List</span>

                            <!-- Search Form -->
                            <div class="row" style="margin-bottom: 20px;">
                                <form action="/admin/products" method="get" class="col s12 m8 l6">
                                    <div class="input-field">
                                        <i class="material-icons prefix">search</i>
                                        <input type="text" id="search" name="search" placeholder="Search products..."
                                            value="<%= search || '' %>" class="validate">
                                        <label for="search">Search</label>
                                    </div>
                                    <button type="submit" class="btn blue darken-2 waves-effect waves-light tooltipped"
                                        data-position="bottom" data-tooltip="Search Products">
                                        <i class="material-icons left">search</i>Search
                                    </button>
                                    <a href="/admin/products"
                                        class="btn grey lighten-1 waves-effect waves-light tooltipped"
                                        data-position="bottom" data-tooltip="Clear Search">
                                        <i class="material-icons left">clear</i>Clear
                                    </a>
                                </form>
                                <div class="col s12 m4 l6 right-align">
                                    <a href="/admin/addProducts"
                                        class="btn green darken-1 waves-effect waves-light tooltipped"
                                        data-position="bottom" data-tooltip="Add New Product">
                                        <i class="material-icons left">add</i>Add Product
                                    </a>
                                </div>
                            </div>

                            <div class="responsive-table">
                                <table class="highlight striped">
                                    <thead>
                                        <tr>
                                            <th>Image</th>
                                            <th>Product</th>
                                            <th>Brand</th>
                                            <th>Category</th>
                                            <th>Regular Price</th>
                                            <th>Sale Price</th>
                                            <th>Total Quantity</th>
                                            <th>Status</th>
                                            <th>Listed</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if (data && Array.isArray(data) && data.length> 0) { %>
                                            <% data.forEach((product, index)=> { %>
                                                <tr>
                                                    <td>
                                                        <% if (product.productImage && product.productImage.length> 0) {
                                                            %>
                                                            <img src="/uploads/product-images/<%= product.productImage[0] %>"
                                                                alt="Product Image"
                                                                style="width:50px; height:50px; object-fit:cover;"
                                                                onerror="this.src='/Uploads/product-images/placeholder.jpg'">
                                                            <% } else { %>
                                                                <img src="/Uploads/product-images/placeholder.jpg"
                                                                    alt="No Image"
                                                                    style="width:50px; height:50px; object-fit:cover;">
                                                                <% } %>
                                                    </td>
                                                    <td>
                                                        <%= product.productName ? product.productName : 'N/A' %>
                                                    </td>
                                                    <td>
                                                        <%= product.brand && product.brand.brandName ?
                                                            product.brand.brandName : 'N/A' %>
                                                    </td>
                                                    <td>
                                                        <%= product.category && product.category.categoryName ?
                                                            product.category.categoryName : 'N/A' %>
                                                    </td>
                                                    <td>₹<%= product.regularPrice ? product.regularPrice : '0' %>
                                                    </td>
                                                    <td>₹<%= product.salePrice ? product.salePrice : '0' %>
                                                    </td>
                                                    <td>
                                                        <%= product.totalQuantity ? product.totalQuantity : '0' %>
                                                    </td>
                                                    <td>
                                                        <%= product.status ? product.status : 'N/A' %>
                                                    </td>
                                                    <td>
                                                        <% if(product.isListed) { %>
                                                            <span class="new badge green"
                                                                data-badge-caption="Listed"></span>
                                                            <% } else { %>
                                                                <span class="new badge red"
                                                                    data-badge-caption="Unlisted"></span>
                                                                <% } %>
                                                    </td>
                                                    <td>
                                                        <% if(product.isListed) { %>
                                                            <button
                                                                onclick="toggleProductListing('<%= product._id %>', false)"
                                                                class="btn waves-effect waves-light red lighten-1 btn-small">Unlist</button>
                                                            <% } else { %>
                                                                <button
                                                                    onclick="toggleProductListing('<%= product._id %>', true)"
                                                                    class="btn waves-effect waves-light green lighten-1 btn-small">List</button>
                                                                <% } %>
                                                                    <a href="/admin/editProduct?id=<%= product._id %>"
                                                                        class="btn waves-effect waves-light blue lighten-1 btn-small">Edit</a>
                                                                    <a href="javascript:void(0);"
                                                                        class="btn waves-effect waves-light orange lighten-1 btn-small"
                                                                        onclick="confirmDelete('<%= product._id %>')">Delete</a>
                                                    </td>
                                                </tr>
                                                <% }) %>
                                                    <% } else { %>
                                                        <tr>
                                                            <td colspan="11" class="center-align">No products found</td>
                                                        </tr>
                                                        <% } %>
                                    </tbody>
                                </table>
                            </div>

                            <div class="center-align">
                                <ul class="pagination">
                                    <% if (currentPage> 1) { %>
                                        <li class="waves-effect">
                                            <a href="?page=<%= currentPage - 1 %>&search=<%= search || '' %>">«
                                                Previous</a>
                                        </li>
                                        <% } else { %>
                                            <li class="disabled"><a>« Previous</a></li>
                                            <% } %>

                                                <% for (let i=1; i <=totalPages; i++) { %>
                                                    <li
                                                        class="<%= i === currentPage ? 'active blue' : 'waves-effect' %>">
                                                        <a href="?page=<%= i %>&search=<%= search || '' %>">
                                                            <%= i %>
                                                        </a>
                                                    </li>
                                                    <% } %>

                                                        <% if (currentPage < totalPages) { %>
                                                            <li class="waves-effect">
                                                                <a
                                                                    href="?page=<%= currentPage + 1 %>&search=<%= search || '' %>">Next
                                                                    »</a>
                                                            </li>
                                                            <% } else { %>
                                                                <li class="disabled"><a>Next »</a></li>
                                                                <% } %>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <script>
        function confirmDelete(productId) {
            Swal.fire({
                title: "Are you sure?",
                text: "This will soft-delete the product.",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#d33",
                cancelButtonColor: "#3085d6",
                confirmButtonText: "Yes, delete it!"
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({ title: 'Deleting...', text: 'Please wait', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });
                    window.location.href = `/admin/deleteProduct?id=${productId}`;
                }
            });
        }
        function toggleProductListing(productId, list) {
            Swal.fire({
                title: `Are you sure?`,
                text: `This will ${list ? 'list' : 'unlist'} the product.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: `Yes, ${list ? 'list' : 'unlist'} it!`
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: `${list ? 'Listing' : 'Unlisting'}...`,
                        text: 'Please wait',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    // Send AJAX request
                    fetch(`/admin/${list ? 'listProduct' : 'unlistProduct'}?id=${productId}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                        .then(response => response.json())
                        .then(data => {
                            Swal.close();
                            if (data.success) {
                                Swal.fire({
                                    title: 'Success!',
                                    text: data.message,
                                    icon: 'success',
                                    timer: 1500,
                                    showConfirmButton: false
                                }).then(() => {
                                    // Update the UI dynamically
                                    const row = document.querySelector(`tr[data-product-id="${productId}"]`);
                                    const statusCell = row.cells[8]; // Listed/Unlisted column
                                    const actionCell = row.cells[9]; // Actions column

                                    // Update Listed/Unlisted badge
                                    statusCell.innerHTML = list
                                        ? '<span class="new badge green" data-badge-caption="Listed"></span>'
                                        : '<span class="new badge red" data-badge-caption="Unlisted"></span>';

                                    // Update List/Unlist button
                                    actionCell.innerHTML = `
                                ${list
                                            ? `<button onclick="toggleProductListing('${productId}', false)" class="btn waves-effect waves-light red lighten-1 btn-small">Unlist</button>`
                                            : `<button onclick="toggleProductListing('${productId}', true)" class="btn waves-effect waves-light green lighten-1 btn-small">List</button>`}
                                <a href="/admin/editProduct?id=${productId}" class="btn waves-effect waves-light blue lighten-1 btn-small">Edit</a>
                                <a href="javascript:void(0);" class="btn waves-effect waves-light orange lighten-1 btn-small" onclick="confirmDelete('${productId}')">Delete</a>
                            `;
                                });
                            } else {
                                Swal.fire({
                                    title: 'Error!',
                                    text: 'Something went wrong.',
                                    icon: 'error',
                                    timer: 2000,
                                    showConfirmButton: false
                                });
                            }
                        })
                        .catch(error => {
                            Swal.close();
                            Swal.fire({
                                title: 'Error!',
                                text: 'Failed to process the request.',
                                icon: 'error',
                                timer: 2000,
                                showConfirmButton: false
                            });
                        });
                }
            });
        }

        // Ensure each table row has a data-product-id attribute for easy selection
        document.addEventListener('DOMContentLoaded', () => {
            const rows = document.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const productId = row.querySelector('td button, td a').getAttribute('onclick').match(/'([^']+)'/)[1];
                row.setAttribute('data-product-id', productId);
            });
        });
    </script>

    <%- include("../../views/partials/admin/footer") %>