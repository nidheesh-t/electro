<%- include("../../views/partials/admin/header") %>

    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, private">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <style>
        .responsive-table img {
            max-width: 50px;
            max-height: 50px;
            object-fit: cover;
        }

        @media screen and (max-width: 600px) {
            .responsive-table {
                font-size: 14px;
            }

            .responsive-table th,
            .responsive-table td {
                padding: 8px 4px;
            }
        }
    </style>

    <main>
        <div class="container">
            <div class="section">
                <h4 class="blue-text text-darken-2">Product Management</h4>
            </div>

            <div class="row">
                <div class="col s12">
                    <div class="card">
                        <div class="card-content">
                            <span class="card-title">Product List</span>

                            <!-- Search Form -->
                            <div class="row" style="margin-bottom: 20px;">
                                <form action="/admin/products" method="get" class="col s12 m8 l6">
                                    <div class="input-field">
                                        <i class="material-icons prefix">search</i>
                                        <input type="text" id="search" name="search" placeholder="Search products..."
                                            value="<%= search || '' %>" class="validate">
                                        <label for="search">Search</label>
                                    </div>
                                    <button type="submit" class="btn blue darken-2 waves-effect waves-light tooltipped"
                                        data-position="bottom" data-tooltip="Search Products">
                                        <i class="material-icons left">search</i>Search
                                    </button>
                                    <a href="/admin/products"
                                        class="btn grey lighten-1 waves-effect waves-light tooltipped"
                                        data-position="bottom" data-tooltip="Clear Search">
                                        <i class="material-icons left">clear</i>Clear
                                    </a>
                                </form>
                                <div class="col s12 m4 l6 right-align">
                                    <a href="/admin/addProducts"
                                        class="btn green darken-1 waves-effect waves-light tooltipped"
                                        data-position="bottom" data-tooltip="Add New Product">
                                        <i class="material-icons left">add</i>Add Product
                                    </a>
                                </div>
                            </div>

                            <div class="responsive-table">
                                <table class="highlight striped">
                                    <thead>
                                        <tr>
                                            <th>Image</th>
                                            <th>Product</th>
                                            <th>Brand</th>
                                            <th>Category</th>
                                            <th>Regular Price</th>
                                            <th>Sale Price</th>
                                            <th>Total Quantity</th>
                                            <th>Status</th>
                                            <th>Listed</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if (data && Array.isArray(data) && data.length> 0) { %>
                                            <% data.forEach((product, index)=> { %>
                                                <tr data-product-id="<%= product._id %>">
                                                    <td>
                                                        <% if (product.productImage && product.productImage.length> 0 && product.productImage[0].url) { %>
                                                            <img src="<%= product.productImage[0].url %>"
                                                                alt="Product Image"
                                                                style="width:50px; height:50px; object-fit:cover;"
                                                                onerror="this.src='/uploads/placeholder.jpg'">
                                                            <% } else { %>
                                                                <img src="/uploads/placeholder.jpg"
                                                                    alt="No Image"
                                                                    style="width:50px; height:50px; object-fit:cover;">
                                                                <% } %>
                                                    </td>
                                                    <td>
                                                        <%= product.productName ? product.productName : 'N/A' %>
                                                    </td>
                                                    <td>
                                                        <%= product.brand && product.brand.brandName ?
                                                            product.brand.brandName : 'N/A' %>
                                                    </td>
                                                    <td>
                                                        <%= product.category && product.category.categoryName ?
                                                            product.category.categoryName : 'N/A' %>
                                                    </td>
                                                    <td>₹<%= product.regularPrice ? product.regularPrice.toLocaleString() : '0' %>
                                                    </td>
                                                    <td>₹<%= product.salePrice ? product.salePrice.toLocaleString() : '0' %>
                                                    </td>
                                                    <td>
                                                        <%= product.totalQuantity ? product.totalQuantity.toLocaleString() : '0' %>
                                                    </td>
                                                    <td>
                                                        <span class="new badge 
                                                            <%= product.status === 'Available' ? 'green' : product.status === 'Out of Stock' ? 'red' : 'grey' %>"
                                                            data-badge-caption="<%= product.status ? product.status : 'N/A' %>">
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <% if(product.isListed) { %>
                                                            <span class="new badge green"
                                                                data-badge-caption="Listed"></span>
                                                            <% } else { %>
                                                                <span class="new badge red"
                                                                    data-badge-caption="Unlisted"></span>
                                                                <% } %>
                                                    </td>
                                                    <td>
                                                        <div class="action-buttons" style="display: flex; flex-direction: column; gap: 5px;">
                                                            <% if(product.isListed) { %>
                                                                <button
                                                                    onclick="toggleProductListing('<%= product._id %>', false)"
                                                                    class="btn waves-effect waves-light red lighten-1 btn-small"
                                                                    style="margin: 2px 0;">
                                                                    <i class="material-icons tiny">visibility_off</i> Unlist
                                                                </button>
                                                                <% } else { %>
                                                                    <button
                                                                        onclick="toggleProductListing('<%= product._id %>', true)"
                                                                        class="btn waves-effect waves-light green lighten-1 btn-small"
                                                                        style="margin: 2px 0;">
                                                                        <i class="material-icons tiny">visibility</i> List
                                                                    </button>
                                                                    <% } %>
                                                                        <a href="/admin/editProduct?id=<%= product._id %>"
                                                                            class="btn waves-effect waves-light blue lighten-1 btn-small"
                                                                            style="margin: 2px 0;">
                                                                            <i class="material-icons tiny">edit</i> Edit
                                                                        </a>
                                                                        <button onclick="confirmDelete('<%= product._id %>')"
                                                                            class="btn waves-effect waves-light orange lighten-1 btn-small"
                                                                            style="margin: 2px 0;">
                                                                            <i class="material-icons tiny">delete</i> Delete
                                                                        </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <% }) %>
                                                    <% } else { %>
                                                        <tr>
                                                            <td colspan="10" class="center-align">No products found</td>
                                                        </tr>
                                                        <% } %>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Pagination -->
                            <% if (totalPages > 1) { %>
                                <div class="center-align">
                                    <ul class="pagination">
                                        <% if (currentPage> 1) { %>
                                            <li class="waves-effect">
                                                <a href="?page=<%= currentPage - 1 %>&search=<%= search || '' %>">
                                                    <i class="material-icons">chevron_left</i>
                                                </a>
                                            </li>
                                            <% } else { %>
                                                <li class="disabled"><a><i class="material-icons">chevron_left</i></a></li>
                                                <% } %>

                                                    <% for (let i=1; i <=totalPages; i++) { %>
                                                        <li
                                                            class="<%= i === currentPage ? 'active blue' : 'waves-effect' %>">
                                                            <a href="?page=<%= i %>&search=<%= search || '' %>">
                                                                <%= i %>
                                                            </a>
                                                        </li>
                                                        <% } %>

                                                            <% if (currentPage < totalPages) { %>
                                                                <li class="waves-effect">
                                                                    <a href="?page=<%= currentPage + 1 %>&search=<%= search || '' %>">
                                                                        <i class="material-icons">chevron_right</i>
                                                                    </a>
                                                                </li>
                                                                <% } else { %>
                                                                    <li class="disabled"><a><i class="material-icons">chevron_right</i></a></li>
                                                                    <% } %>
                                    </ul>
                                </div>
                                <% } %>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <script>
        // Initialize Materialize components
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize tooltips
            const tooltips = document.querySelectorAll('.tooltipped');
            M.Tooltip.init(tooltips);
        });

        function confirmDelete(productId) {
            Swal.fire({
                title: "Are you sure?",
                text: "This will delete the product permanently.",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#d33",
                cancelButtonColor: "#3085d6",
                confirmButtonText: "Yes, delete it!",
                cancelButtonText: "Cancel"
            }).then((result) => {
                if (result.isConfirmed) {
                    // Show loading indicator
                    Swal.fire({
                        title: 'Deleting...',
                        text: 'Please wait',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    // Redirect to delete endpoint
                    window.location.href = `/admin/deleteProduct?id=${productId}`;
                }
            });
        }

        function toggleProductListing(productId, list) {
            Swal.fire({
                title: `Are you sure?`,
                text: `This will ${list ? 'list' : 'unlist'} the product.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: `Yes, ${list ? 'list' : 'unlist'} it!`,
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Show loading indicator
                    Swal.fire({
                        title: `${list ? 'Listing' : 'Unlisting'}...`,
                        text: 'Please wait',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    // Send AJAX request
                    fetch(`/admin/${list ? 'listProduct' : 'unlistProduct'}?id=${productId}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        Swal.close();
                        
                        if (data.success) {
                            // Show success message
                            Swal.fire({
                                title: 'Success!',
                                text: data.message,
                                icon: 'success',
                                timer: 1500,
                                showConfirmButton: false
                            }).then(() => {
                                // Reload the page to reflect changes
                                window.location.reload();
                            });
                        } else {
                            throw new Error(data.message || 'Operation failed');
                        }
                    })
                    .catch(error => {
                        Swal.close();
                        Swal.fire({
                            title: 'Error!',
                            text: error.message || 'Failed to process the request.',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                    });
                }
            });
        }

        // Add row hover effects
        document.addEventListener('DOMContentLoaded', function() {
            const rows = document.querySelectorAll('tbody tr');
            rows.forEach(row => {
                row.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = '#f5f5f5';
                });
                row.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = '';
                });
            });
        });

        // Enhanced search functionality
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('search');
            if (searchInput) {
                // Clear search when Escape key is pressed
                searchInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        this.value = '';
                        this.form.submit();
                    }
                });
            }
        });
    </script>

    <style>
        .action-buttons .btn {
            width: 100%;
            height: 32px;
            line-height: 32px;
            padding: 0 8px;
        }
        
        .action-buttons .btn i.material-icons {
            font-size: 14px;
            margin-right: 4px;
        }
        
        .responsive-table {
            overflow-x: auto;
        }
        
        @media (max-width: 768px) {
            .action-buttons {
                flex-direction: row !important;
                flex-wrap: wrap;
            }
            
            .action-buttons .btn {
                flex: 1;
                min-width: 60px;
                margin: 2px;
            }
            
            .action-buttons .btn i.material-icons {
                margin-right: 0;
            }
            
            .action-buttons .btn span {
                display: none;
            }
        }
    </style>

<%- include("../../views/partials/admin/footer") %>